# TryHackMe: Intro to Malware Analysis Room Summary

Room URL: https://tryhackme.com/room/intromalwareanalysis




1. [Malware Analysis Overview](#malware-analysis-overview)
2. [Techniques of malware analysis](#techniques-of-malware-analysis)
3. [Basic Static Malware Analysis](#basic-static-malware-analysis)
4. [Basic Dynamic Malware Analysis](#basic-dynamic-malware-analysis)
5. [PE (Portable Executable) Header](#pe-portable-executable-header)



---
# Malware Analysis Overview

## What is Malware?
- The term **malware** is short for **MALicious softWARE**.
- Any software designed with a harmful intent is classified as malware.
- Malware can be further categorized based on its behavior.


## Purpose of Malware Analysis
Malware Analysis is a key skill in cybersecurity and is performed by:

- **Security Operations Teams**  
  To create detection rules for malicious activities.

- **Incident Response Teams**  
  To assess and remediate damage caused by malware.

- **Threat Hunting Teams**  
  To identify Indicators of Compromise (IOCs) and locate malware in the network.

- **Malware Researchers (Product Vendors)**  
  To improve detection in security products.

- **Threat Research Teams (e.g., Microsoft, Google)**  
  To find exploited vulnerabilities and enhance OS/app security.

## Precautions Before Malware Analysis

‚ö†Ô∏è Malware is dangerous and must be handled with extreme care.

### Safety Guidelines:
1. **Use a dedicated system** only for malware analysis.
2. **Store malware in password-protected archives** (e.g., ZIP/RAR) when not analyzing.
3. **Only extract malware** within the isolated environment when actively analyzing.
4. **Use a dedicated and isolated Virtual Machine (VM)** for analysis.
5. **Disable or monitor all internet connections** during analysis.
6. **Revert the VM to a clean state** after each session to avoid contamination.


---
# Techniques of malware analysis


Malware Analysis is like solving a puzzle. Various tools and techniques help uncover different pieces, which when joined together reveal the malware's behavior.

Most commonly analyzed files:
- **PE files (Portable Executables)**
- **Malicious documents**
- **Network captures (Pcap files)**



## Types of Malware Analysis

###  Static Analysis
- **Definition:** Analyzing malware without executing it.
- **Examples:**
  - Viewing readable strings in the file.
  - Checking the PE header and sections.
  - Using disassemblers to view assembly code.
- **Used For:**
  - Gathering basic information safely.
  - Initial triage or fast assessments.

#### Evasion Techniques
- Malware may use:
  - **Obfuscation**
  - **Packing**
  - **Code hiding**  
  These are used to hinder static analysis.

### Dynamic Analysis
- **Definition:** Running the malware in a controlled environment to observe behavior.
- **Examples:**
  - Executing malware in a Virtual Machine (VM).
  - Using automated sandboxes.
  - Monitoring file, process, registry, and network activity.
- **Benefits:**
  - Detects runtime behavior that static analysis misses.
  - Leverages knowledge of Windows Forensics to track activity.

#### Evasion Techniques
- Malware may detect:
  - **VMs**, **Sandboxes**, or **Analysis Tools**
- If detected, it may run **benign code** to avoid detection.



## Advanced Malware Analysis
Used when:
- Malware evades basic static and dynamic techniques.

### Tools:
- **Disassemblers**
  - Convert binary code to human-readable assembly.
  - Useful for deep static inspection.
  
- **Debuggers**
  - Allow step-by-step execution of malware.
  - Help monitor memory and CPU usage.
  - Let analysts pause/resume execution to extract valuable insights.


---
# Basic Static Malware Analysis

**Basic Static Analysis** involves inspecting malware without executing it. Analysts gather initial information by examining:

- File metadata
- Strings embedded in the binary
- PE (Portable Executable) headers
- Imported functions and libraries
- Hashes (MD5/SHA1/SHA256)
- File signatures and timestamps

This provides a **safe and quick way** to understand what a file might do.

## Common Tasks in Basic Static Analysis

| Task                         | Description |
|-----------------------------|-------------|
| **File Hashing**            | Calculate MD5, SHA1, or SHA256 to uniquely identify the file. |
| **Viewing Strings**         | Extract human-readable text (e.g., URLs, commands, registry keys). |
| **Checking PE Header**      | Analyze structure, entry point, sections, imports/exports. |
| **Detecting Packing**       | Check if the file is packed or obfuscated. |
| **Checking Digital Signatures** | Verify file authenticity and source. |


## REMnux VM: Static Analysis Tools

[REMnux](https://remnux.org/) is a Linux-based VM loaded with reverse engineering and malware analysis tools.

### Useful REMnux Commands for Static Analysis:

| Tool/Command      | Purpose |
|-------------------|---------|
| `strings`         | Extract ASCII/Unicode strings from files. |
| `sha256sum` / `md5sum` | Generate cryptographic file hashes. |
| `peframe`         | Analyze PE file structure and extract IOCs. |
| `exiftool`        | Extract file metadata. |
| `binwalk`         | Identify and extract embedded files from binaries. |
| `upx -d`          | Unpack UPX-packed executables. |
| `file`            | Detect file type. |
| `r2` (Radare2)    | Lightweight disassembler/debugger. |
| `clamav`          | Run ClamAV antivirus scan for known signatures. |



## External Tools for Static Analysis

### Windows-Based Tools

| Tool            | Function |
|------------------|----------|
| **PEview**       | Inspect PE file headers and section details. |
| **PE-bear**      | Analyze PE file structure in a user-friendly interface. |
| **Detect It Easy (DIE)** | Detect packers, compilers, and malware signatures. |
| **Strings (Sysinternals)** | Extract readable text from binaries. |
| **VirusTotal**   | Online multi-antivirus scan and reputation check. |
| **Hybrid Analysis** | Upload files for automated behavioral and static analysis. |
| **Any.run**      | Interactive malware sandbox for analysis (free tier available). |



---
# Basic Dynamic Malware Analysis


**Dynamic Analysis** involves **executing malware in a controlled environment** to observe its real behavior in real time.

While static analysis provides clues, dynamic analysis reveals **what the malware actually does**, including:

- File system changes
- Network communications
- Registry modifications
- Process and service creation
- Persistence techniques


## üéØ Why Use Dynamic Analysis?

| Benefit                      | Description |
|-----------------------------|-------------|
| **Observe Real Behavior**    | See exactly how the malware behaves when executed. |
| **Bypass Obfuscation**       | Obfuscated or packed code reveals itself during execution. |
| **Detect Network IOCs**      | Catch URLs, IPs, and domains contacted. |
| **Identify File & Registry Activity** | Uncover system changes and potential persistence. |
| **Supports Forensics**       | Complements Windows Forensics and log analysis. |



## Common Dynamic Analysis Techniques

| Technique                      | Description |
|-------------------------------|-------------|
| **Manual Execution in a VM**  | Analyst launches malware in a virtual machine with monitoring tools. |
| **Automated Sandboxing**      | Upload malware to cloud-based or local sandboxes that execute and analyze it. |
| **Network Monitoring**        | Tools like Wireshark or Fake DNS servers track external communication. |
| **System Monitoring**         | Track file, registry, process, and service activity during execution. |


## Recommended Environment Setup

- Use a **dedicated VM** (e.g., Windows 10 on **VirtualBox** or **VMware**).
- Disable shared folders, clipboard, and drag-and-drop.
- **Take a snapshot** before execution to revert later.
- Use **REMnux** or **FLARE VM** alongside Windows VM for hybrid analysis.
- Disable/limit internet access unless network monitoring is required.
- Isolate malware samples in password-protected `.zip` or `.rar` files (`infected` is a common password).


## Tools for Dynamic Analysis

### In a Windows Analysis VM

| Tool             | Purpose |
|------------------|---------|
| **Process Monitor (ProcMon)** | Monitor file, registry, and process activity in real time. |
| **Process Explorer** | View running processes and details (command line, parent, etc.). |
| **Autoruns**     | Check for persistence mechanisms. |
| **TCPView**      | View active TCP/UDP connections. |
| **Wireshark**    | Monitor and capture network traffic. |
| **Regshot**      | Compare registry snapshots (before/after execution). |
| **ApateDNS / FakeNet-NG** | Simulate DNS/network responses to observe malware behavior. |

### Online Sandboxes (for limited-risk use)

| Sandbox          | Description |
|------------------|-------------|
| **[Any.run](https://any.run/)**      | Interactive online sandbox with visual behavior analysis. |
| **[Hybrid Analysis](https://hybrid-analysis.com/)** | Static + dynamic analysis reports with threat scoring. |
| **Joe Sandbox**  | Advanced dynamic analysis with behavioral signatures. |
| **CAPEv2**       | Community-powered sandbox that captures IOCs. |



## Evasion Techniques Used by Malware

Malware often attempts to **evade dynamic analysis** by detecting:

- Virtual environments (VMs)
- Debugging tools
- Analysis tools (ProcMon, Wireshark, etc.)
- Lack of user activity (no mouse/keyboard input)

### Common Anti-Analysis Tricks:
- Delayed execution (sleep timers)
- Environment checks (VMware files, registry keys)
- Process checks (e.g., detecting `procmon.exe`)
- Decryption/decoding payloads at runtime only



## Tips for Effective Dynamic Analysis

- Use **realistic system configurations** (username, files, browser history).
- Simulate user behavior (move mouse, open apps).
- Use **instrumented tools** like Cuckoo or open-source sandboxes.
- Revert VM after every test to avoid contamination.
- Monitor both host and guest network traffic if applicable.


---
# PE (Portable Executable) Header

The **PE Header** is a crucial part of any Windows executable file (`.exe`, `.dll`, `.sys`, etc.). It provides metadata that tells the Windows operating system **how to load and execute the file**. For malware analysts, examining the PE header can reveal valuable information about the file‚Äôs origin, structure, and behavior.



## What is a PE File?

A **PE file** is a file format used in Windows operating systems for executables, object code, and DLLs. It builds upon the older **COFF (Common Object File Format)** structure used in UNIX.


## Main Components of a PE File

```
+--------------------------+
| DOS Header (MZ)          |
+--------------------------+
| DOS Stub                 |
+--------------------------+
| PE Header (Signature)    |
+--------------------------+
| File Header              |
+--------------------------+
| Optional Header          |
+--------------------------+
| Section Headers          |
+--------------------------+
| Sections (.text, .data)  |
+--------------------------+
```
> for more information about PE header visit -> [PE Format-Win32 apps](https://learn.microsoft.com/en-us/windows/win32/debug/pe-format)
**Example**:

This is a PE header for a malware called redline using `pe-tree <malware file>` command:

![Screenshot 2025-06-02 142511](https://github.com/user-attachments/assets/5a1abd41-690b-46c3-942b-f8deb8a2d857)
![Screenshot 2025-06-02 142533](https://github.com/user-attachments/assets/af4ad150-a569-4cac-b787-636320de9c7c)

